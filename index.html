<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Piano Learning App</title>
<style>
body{margin:0;font-family:sans-serif;background:#f0f0f0;color:#111;transition:background .3s,color .3s}
.dark{background:#1e1e1e;color:white}
header{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#333;color:white;box-shadow:0 4px 10px rgba(0,0,0,.2)}
header h1{margin:0;font-size:1.5rem}
#theme-toggle{cursor:pointer;padding:.5rem 1rem;background:#555;border:none;color:white;border-radius:5px;transition:background .3s}
#theme-toggle:hover{background:#777}
.page{display:none;padding:1rem;}
.page.active{display:block;}
button{padding:.5rem 1rem;border:none;border-radius:5px;cursor:pointer;transition:background .3s;margin-top:.5rem}
button:hover{background:#ddd}
#piano{display:flex;position:relative;user-select:none;margin-top:1rem;}
.white{width:40px;height:160px;border:1px solid black;background:white;position:relative;display:flex;justify-content:center;align-items:flex-end;font-size:10px;cursor:pointer;border-radius:5px;z-index:1;transition:background .3s;margin-right:-1px}
.white.highlight{background:yellow}
.white.correct{background:green;color:white}
.white.wrong{background:red;color:white}
.black{width:25px;height:100px;background:black;position:absolute;display:flex;justify-content:center;align-items:flex-end;font-size:9px;color:white;cursor:pointer;border-radius:3px;z-index:2;transition:background .3s}
.black.highlight{background:gold}
.black.correct{background:green;color:white}
.black.wrong{background:red;color:white}
#progress-container{height:20px;background:#ccc;border-radius:10px;overflow:hidden;margin-top:.5rem}
#progress{height:100%;width:0%;background:green;transition:width .3s}
#song-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:10}
#song-content{background:white;padding:1rem;border-radius:10px;max-width:600px;width:90%;max-height:80%;overflow-y:auto}
.dark #song-content{background:#2a2a2a;color:white}
#song-list div{padding:.5rem 1rem;border-radius:5px;background:#eee;margin:.2rem 0;cursor:pointer}
.dark #song-list div{background:#444;color:white}
#song-list div:hover{background:#ddd}
.dark #song-list div:hover{background:#555}
</style>
</head>
<body>
<header>
<h1>Ultimate Piano Learning App</h1>
<button id="theme-toggle">Toggle Theme</button>
</header>

<!-- Landing Page -->
<div id="landing" class="page active">
<h2>Welcome!</h2>
<p>Select your piano keyboard setup:</p>
<label for="num2">Number of 2-black key groups:</label>
<input type="number" id="num2" value="5" min="1" max="10"><br>
<label for="num3">Number of 3-black key groups:</label>
<input type="number" id="num3" value="6" min="1" max="10"><br>
<button id="start-calibration-btn">Start Calibration</button>
</div>

<!-- Calibration Page -->
<div id="calibration-page" class="page">
<h2>Calibration</h2>
<p id="calibration-instruction">Enable microphone and play highlighted keys one by one.</p>
<div id="piano"></div>
<div id="progress-container"><div id="progress"></div></div>
</div>

<!-- Lessons Page -->
<div id="lessons-page" class="page">
<h2>Lessons</h2>
<div id="lesson-area">
<p id="lesson-instruction"></p>
<button id="next-lesson">Next Note</button>
</div>
</div>

<!-- Song Page -->
<div id="song-page" class="page">
<h2>Song Library</h2>
<input type="text" id="song-search" placeholder="Search a song">
<div id="song-list"></div>
</div>

<!-- Song Modal -->
<div id="song-modal">
<div id="song-content">
<h3 id="song-title"></h3>
<p id="song-chords"></p>
<button id="close-song">Close</button>
</div>
</div>

<script>
// ======================== Theme Toggle ========================
document.getElementById('theme-toggle').onclick=()=>{
  document.body.classList.toggle('dark');
};

// ======================== Pages ========================
const landing=document.getElementById('landing');
const calibrationPage=document.getElementById('calibration-page');
const lessonsPage=document.getElementById('lessons-page');
const songPage=document.getElementById('song-page');

// ======================== Piano Generation ========================
let NOTES=[], whiteKeys=[], blackKeys=[], currentCalibrationIndex=0, calibratedNotes=[];
let pianoContainer=document.getElementById('piano');
let audioContext=null, analyser=null, dataArray=null, source=null;
let lessonIndex=0;

// Generate keyboard notes based on 2-black/3-black groups
function generateKeyboard(num2,num3){
  NOTES=[];
  whiteKeys=[]; blackKeys=[];
  const whiteOrder=['C','D','E','F','G','A','B'];
  const blackOrder=['C#','D#','F#','G#','A#'];
  let octave=1;
  let wCount=0;
  for(let g=0;g<num3+num2;){
    if(num3>0){ // 3-black group
      NOTES.push(`C${octave}`); NOTES.push(`D${octave}`); NOTES.push(`E${octave}`);
      NOTES.push(`F${octave}`); NOTES.push(`G${octave}`); NOTES.push(`A${octave}`); NOTES.push(`B${octave}`);
      octave++; num3--; g++;
    }else if(num2>0){ // 2-black group
      NOTES.push(`C${octave}`); NOTES.push(`D${octave}`); NOTES.push(`E${octave}`);
      NOTES.push(`F${octave}`); NOTES.push(`G${octave}`); NOTES.push(`A${octave}`); NOTES.push(`B${octave}`);
      octave++; num2--; g++;
    }
  }
}

// Build piano visually with proper black/white spacing
function buildPiano(){
  pianoContainer.innerHTML='';
  let whiteCount=0;
  NOTES.forEach((note,i)=>{
    const key=document.createElement('div');
    if(note.includes('#')){key.className='black'; blackKeys.push(key);}
    else{key.className='white'; whiteKeys.push(key);}
    key.textContent=note;
    key.dataset.note=note;
    pianoContainer.appendChild(key);
  });
  // Position black keys over white keys
  blackKeys.forEach((b,i)=>{
    const left=whiteKeys[i].offsetLeft+30;
    b.style.left=left+'px';
  });
}

// ======================== Calibration ========================
async function startCalibration(){
  const num2=parseInt(document.getElementById('num2').value)||5;
  const num3=parseInt(document.getElementById('num3').value)||6;
  generateKeyboard(num2,num3);
  buildPiano();
  highlightKey(currentCalibrationIndex);
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioContext=new AudioContext();
    source=audioContext.createMediaStreamSource(stream);
    analyser=audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize=2048;
    dataArray=new Float32Array(analyser.frequencyBinCount);
    detectPitchLoop();
  }catch(err){alert('Microphone access required!');}
}

// Highlight current key
function highlightKey(index){
  const keys=pianoContainer.querySelectorAll('.white,.black');
  keys.forEach(k=>k.classList.remove('highlight','correct','wrong'));
  if(index<keys.length){
    keys[index].classList.add('highlight');
    document.getElementById('calibration-instruction').textContent=`Play: ${NOTES[index]}`;
    document.getElementById('progress').style.width=((index)/NOTES.length*100)+'%';
  }
}

// ======================== Pitch Detection ========================
function detectPitchLoop(){
  analyser.getFloatTimeDomainData(dataArray);
  let freq=autoCorrelate(dataArray,audioContext.sampleRate);
  if(freq && currentCalibrationIndex<NOTES.length){
    const note=frequencyToNote(freq);
    if(note===NOTES[currentCalibrationIndex]){
      calibratedNotes.push(note);
      const keys=pianoContainer.querySelectorAll('.white,.black');
      keys[currentCalibrationIndex].classList.add('correct');
      currentCalibrationIndex++;
      if(currentCalibrationIndex<NOTES.length) highlightKey(currentCalibrationIndex);
      else {alert('Calibration complete!'); startLessons();}
    }
  }
  requestAnimationFrame(detectPitchLoop);
}
function frequencyToNote(freq){
  const A4=440;
  const noteNum=12*(Math.log2(freq/A4))+69;
  const rounded=Math.round(noteNum);
  return NOTES[rounded]||null;
}
function autoCorrelate(buf,sampleRate){
  let SIZE=buf.length,rms=0;
  for(let i=0;i<SIZE;i++) rms+=buf[i]*buf[i];
  rms=Math.sqrt(rms/SIZE);
  if(rms<0.01) return null;
  let r=[]; for(let i=0;i<SIZE;i++){r[i]=0; for(let j=0;j<SIZE-i;j++) r[i]+=buf[j]*buf[j+i];}
  let d=0; while(r[d]>r[d+1]) d++;
  let maxval=-1,maxpos=-1; for(let i=d;i<SIZE;i++){if(r[i]>maxval){maxval=r[i];maxpos=i;}} 
  return sampleRate/maxpos;
}

// ======================== Lessons ========================
function startLessons(){
  calibrationPage.classList.remove('active');
  lessonsPage.classList.add('active');
  lessonIndex=0;
  showLesson(0);
}
const lessons=[
{title:'Lesson 1',notes:['C4','D4','E4','F4']},
{title:'Lesson 2',notes:['E4','F4','G4','A4']},
{title:'Lesson 3',notes:['C4','E4','G4']}
];
function showLesson(idx){
  lessonIndex=0;
  document.getElementById('lesson-instruction').textContent=`${lessons[idx].title}: Play ${lessons[idx].notes[lessonIndex]}`;
}
document.getElementById('next-lesson').onclick=()=>{
  const lesson=lessons[0];
  lessonIndex++;
  if(lessonIndex<lesson.notes.length) document.getElementById('lesson-instruction').textContent=`Play: ${lesson.notes[lessonIndex]}`;
  else alert('Lesson complete!');
}

// ======================== Start Calibration Button ========================
document.getElementById('start-calibration-btn').onclick=()=>{
  landing.classList.remove('active');
  calibrationPage.classList.add('active');
  startCalibration();
};

// ======================== Song Page Modal ========================
const songSearch=document.getElementById('song-search');
const songList=document.getElementById('song-list');
songSearch.oninput=()=>{
  const val=songSearch.value.toLowerCase();
  songList.innerHTML='';
  if(!val) return;
  const chords='C G Am F'; // placeholder
  const div=document.createElement('div');
  div.textContent=val;
  div.onclick=()=>{
    document.getElementById('song-modal').style.display='flex';
    document.getElementById('song-title').textContent=val;
    document.getElementById('song-chords').textContent='Chords: '+chords;
  };
  songList.appendChild(div);
};
document.getElementById('close-song').onclick=()=>{document.getElementById('song-modal').style.display='none';};
</script>
</body>
</html>
